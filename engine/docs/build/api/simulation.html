
    <!doctype html>

    <html lang="en">
    <head>
    <meta charset="utf-8">
    <style>
    pre { line-height: 125%; margin: 0; }
    td.linenos pre { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
    span.linenos { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
    td.linenos pre.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
    span.linenos.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
    .codehilite .hll { background-color: #ffffcc }
    .codehilite { background: #f8f8f8; }
    .codehilite .c { color: #408080; font-style: italic } /* Comment */
    .codehilite .err { border: 1px solid #FF0000 } /* Error */
    .codehilite .k { color: #008000; font-weight: bold } /* Keyword */
    .codehilite .o { color: #666666 } /* Operator */
    .codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
    .codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
    .codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
    .codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
    .codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
    .codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
    .codehilite .gd { color: #A00000 } /* Generic.Deleted */
    .codehilite .ge { font-style: italic } /* Generic.Emph */
    .codehilite .gr { color: #FF0000 } /* Generic.Error */
    .codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .codehilite .gi { color: #00A000 } /* Generic.Inserted */
    .codehilite .go { color: #888888 } /* Generic.Output */
    .codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
    .codehilite .gs { font-weight: bold } /* Generic.Strong */
    .codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .codehilite .gt { color: #0044DD } /* Generic.Traceback */
    .codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
    .codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
    .codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
    .codehilite .kp { color: #008000 } /* Keyword.Pseudo */
    .codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
    .codehilite .kt { color: #B00040 } /* Keyword.Type */
    .codehilite .m { color: #666666 } /* Literal.Number */
    .codehilite .s { color: #BA2121 } /* Literal.String */
    .codehilite .na { color: #7D9029 } /* Name.Attribute */
    .codehilite .nb { color: #008000 } /* Name.Builtin */
    .codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
    .codehilite .no { color: #880000 } /* Name.Constant */
    .codehilite .nd { color: #AA22FF } /* Name.Decorator */
    .codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
    .codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
    .codehilite .nf { color: #0000FF } /* Name.Function */
    .codehilite .nl { color: #A0A000 } /* Name.Label */
    .codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
    .codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
    .codehilite .nv { color: #19177C } /* Name.Variable */
    .codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
    .codehilite .w { color: #bbbbbb } /* Text.Whitespace */
    .codehilite .mb { color: #666666 } /* Literal.Number.Bin */
    .codehilite .mf { color: #666666 } /* Literal.Number.Float */
    .codehilite .mh { color: #666666 } /* Literal.Number.Hex */
    .codehilite .mi { color: #666666 } /* Literal.Number.Integer */
    .codehilite .mo { color: #666666 } /* Literal.Number.Oct */
    .codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
    .codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
    .codehilite .sc { color: #BA2121 } /* Literal.String.Char */
    .codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
    .codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
    .codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
    .codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
    .codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
    .codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
    .codehilite .sx { color: #008000 } /* Literal.String.Other */
    .codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
    .codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
    .codehilite .ss { color: #19177C } /* Literal.String.Symbol */
    .codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
    .codehilite .fm { color: #0000FF } /* Name.Function.Magic */
    .codehilite .vc { color: #19177C } /* Name.Variable.Class */
    .codehilite .vg { color: #19177C } /* Name.Variable.Global */
    .codehilite .vi { color: #19177C } /* Name.Variable.Instance */
    .codehilite .vm { color: #19177C } /* Name.Variable.Magic */
    .codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
    </head>
    <body>
<h1 id="api-reference-simulation">API Reference - Simulation</h1>
<div class="toc">
<ul>
<li><a href="#api-reference-simulation">API Reference - Simulation</a><ul>
<li><a href="#simulationnew">Simulation.new()</a></li>
<li><a href="#simulationaddsystemsystem">Simulation:addSystem(system)</a></li>
<li><a href="#simulationrun">Simulation:run()</a></li>
<li><a href="#simulationbroadcastevent">Simulation:broadcast(event, ...)</a></li>
<li><a href="#simulationdumpfilename">Simulation:dump(filename)</a></li>
<li><a href="#simulationsavefilename">Simulation:save(filename)</a></li>
<li><a href="#simulationloadfilename">Simulation:load(filename)</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="simulationnew">Simulation.new()</h2>
<p>Create a new simulation.</p>
<p><strong>Arguments</strong></p>
<p><strong>Returns</strong></p>
<ul>
<li>simulation object which can be run with simulation:run()</li>
</ul>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">simulation</span><span class="p">:</span><span class="n">addSystem</span><span class="p">(</span><span class="n">MyGame</span><span class="p">)</span>
<span class="n">simulation</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>


<h2 id="simulationaddsystemsystem">Simulation:addSystem(system)</h2>
<p>Adds the specified system to the simulation, if not already present.  Returns an instance of that system.</p>
<p>Systems are uniquely keyed by system.SYSTEM_NAME. If a system with that key does not exist, this method will instantiate the system as follows:</p>
<ul>
<li>Creates a new table, systemInstance</li>
<li>set system as the metatable for systemInstance</li>
<li>registers systemInstance into the simulation's SYSTEM_NAME to system instance mapping</li>
</ul>
<p><strong>Arguments</strong></p>
<ul>
<li>"system" - metatable used for the system instance</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>instance of the specified system</li>
</ul>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Entity</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;engine/entity&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">PhysicsSys</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- unique string key for the system,</span>
<span class="n">PhysicsSys</span><span class="p">.</span><span class="n">SYSTEM_NAME</span> <span class="o">=</span> <span class="s2">&quot;physicsSys&quot;</span>

<span class="c1">-- triggered once when the simulation</span>
<span class="c1">-- triggered immediately if the system is added after simulation is created</span>
<span class="kr">function</span> <span class="nc">PhysicsSys</span><span class="p">:</span><span class="nf">onInit</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation</span>
    <span class="n">self</span><span class="p">.</span><span class="n">entitySys</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">simulation</span><span class="p">:</span><span class="n">addSystem</span><span class="p">(</span><span class="n">Entity</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- triggered once per simulation step (60 times a second, when run from the client)</span>
<span class="kr">function</span> <span class="nc">PhysicsSys</span><span class="p">:</span><span class="nf">onStep</span><span class="p">()</span>
    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entity</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">entitySys</span><span class="p">:</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;physics&quot;</span><span class="p">))</span> <span class="kr">do</span>
        <span class="n">self</span><span class="p">.</span><span class="n">entitySys</span><span class="p">:</span><span class="n">movePos</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">-- add 1 to y every frame; not the most exciting gravity physics</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div>


<h2 id="simulationrun">Simulation:run()</h2>
<p>Runs the simulation loop until completion.</p>
<p>When run from the client, this ends when the client window is closed or ESC is pressed.</p>
<p>When run headless (from a lua interpreter) the simulation will start, step once, and then stop.</p>
<p><strong>Arguments</strong></p>
<p><strong>Returns</strong></p>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">simulation</span><span class="p">:</span><span class="n">addSystem</span><span class="p">(</span><span class="n">MyGame</span><span class="p">)</span>
<span class="n">simulation</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>


<h2 id="simulationbroadcastevent">Simulation:broadcast(event, ...)</h2>
<p>Trigger an event.  For each system, if there is an method matching the <em>event</em> name to handle the event,
call this event handler with the variadic arguments (...).</p>
<p><strong>Arguments</strong></p>
<ul>
<li>
<p>"event" - string event name key</p>
</li>
<li>
<p>"..." - variadic arguments to forward to the event handler</p>
</li>
</ul>
<p><strong>Returns</strong></p>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">MessageSystem</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">MessageSystem</span><span class="p">.</span><span class="n">SYSTEM_NAME</span> <span class="o">=</span> <span class="s2">&quot;MessageSystem&quot;</span>
<span class="kr">function</span> <span class="nc">MessageSystem</span><span class="p">:</span><span class="nf">onMessage</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="kr">end</span>

<span class="n">simulation</span><span class="p">:</span><span class="n">addSys</span><span class="p">(</span><span class="n">SomeSystem</span><span class="p">)</span>
<span class="n">simulation</span><span class="p">:</span><span class="n">broadcast</span><span class="p">(</span><span class="s2">&quot;onMessage&quot;</span><span class="p">,</span> <span class="s2">&quot;hello!&quot;</span><span class="p">)</span>
<span class="c1">-- prints &quot;hello!&quot;</span>
</code></pre></div>


<h2 id="simulationdumpfilename">Simulation:dump(filename)</h2>
<p>Serializes as much of the simulation as possible to JSON,
and saves this as JSON to the given filename.</p>
<p>Note: this is a very slow operation, and the output can be quite large.</p>
<p><strong>Arguments</strong></p>
<ul>
<li>"filename" - string filename where the simulation dump json should be written to</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>true if successful, else false</li>
</ul>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">simulation</span><span class="p">:</span><span class="n">dump</span><span class="p">(</span><span class="s2">&quot;simulation_dump.json&quot;</span><span class="p">)</span>
</code></pre></div>


<h2 id="simulationsavefilename">Simulation:save(filename)</h2>
<p>Saves simulation state as gzipped JSON to the given filename.  Only state in simulation.state is saved.</p>
<p>There are some major restrictions simulation.state must adhere to, in order to support saving:</p>
<ul>
<li>no table recursion, i.e. a table cannot contain itself, directly or indirectly</li>
<li>primitive types only, i.e. must only be composed of tables, strings, numbers, bool, and nil</li>
<li>no sparse arrays (nils in tables containing only number keys)</li>
<li>cannot mix string keys and number keys in tables</li>
</ul>
<p>There are also some restrictions which simulation.state should adhere to, else information will be lost:</p>
<ul>
<li>no metatables - tables will not include their metatable nor metatable members when the save is loaded</li>
<li>only store one reference to a table - each reference will be its own table when the save is loaded</li>
</ul>
<p><strong>Arguments</strong></p>
<ul>
<li>"filename" - string filename where save should be written to</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>true if successful, else false</li>
</ul>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">simulation</span><span class="p">:</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;save.dat&quot;</span><span class="p">)</span>
</code></pre></div>


<h2 id="simulationloadfilename">Simulation:load(filename)</h2>
<p>Loads simulation state as gzipped JSON from the given filename.  If successful, replaces what is already in simulation.state.</p>
<p><strong>Arguments</strong></p>
<ul>
<li>"filename" - string filename where save should be read from</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>true if successful, else false</li>
</ul>
<p><strong>Examples</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">simulation</span><span class="p">:</span><span class="nb">load</span><span class="p">(</span><span class="s2">&quot;save.dat&quot;</span><span class="p">)</span>
</code></pre></div>
    </body>
    </html>
